from typing import List, Dict, Any, Optional

def create_yandex_messages(system_prompt: str, user_content: str) -> List[Dict[str, str]]:
    """
    –°–æ–∑–¥–∞—ë—Ç —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ YandexGPT API
    
    Args:
        system_prompt: –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏
        user_content: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        
    Returns:
        –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ YandexGPT
    """
    return [
        {
            "role": "system",
            "text": system_prompt
        },
        {
            "role": "user",
            "text": user_content
        }
    ]

def compliments_messages(chat_text: str) -> List[Dict[str, str]]:
    """–°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–æ–≤"""
    system_prompt = (
        "–¢—ã ‚Äî —Å–∞–º—ã–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ —Ç–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–∏–∞–ª–æ–≥–æ–≤."
        "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —á–∞—Ç –∏ –ø–æ–¥—Å—á–∏—Ç–∞–π, —Å–∫–æ–ª—å–∫–æ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–æ–≤ —Å–¥–µ–ª–∞–ª –∫–∞–∂–¥—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫. "
        "–í–ê–ñ–ù–û: –æ—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON. –í –∫–∞—á–µ—Å—Ç–≤–µ –∫–ª—é—á–µ–π –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—ã–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, "
        "–∫–∞–∫ –æ–Ω–∏ —É–∫–∞–∑–∞–Ω—ã –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞ 'SenderId' –∏–ª–∏ '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'. "
        "–ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—ã–µ ID, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –≤ –∫–ª—é—á–∞—Ö."
        "–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞: {\"123\": 3, \"456\": 1}"
        "–ü—Ä–∏–º–µ—Ä –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞: {\"SenderId_123\": 3, \"user\": 1}"
    )
    user_content = f"–ß–∞—Ç:\n{chat_text}\n\n–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞: {{\"123\": 3, \"456\": 1}}"
    
    return create_yandex_messages(system_prompt, user_content)

def engagement_messages(chat_text: str, user_ids: list, historical_summary: str = "", previous_engagement: dict = None) -> list:
    """–°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏"""
    system_prompt = (
        "–¢—ã ‚Äî —Å–∞–º—ã–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ —Ç–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–∏–∞–ª–æ–≥–æ–≤."
        "–ù–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –º–µ–∂–¥—É –¥–≤—É–º—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞–º–∏ –∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ü–µ–Ω–∏ —É—Ä–æ–≤–µ–Ω—å –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ (–æ—Ç 0 –¥–æ 100). "
        "–ï—Å–ª–∏ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ —É–∂–µ –±—ã–ª —Å–¥–µ–ª–∞–Ω –ø—Ä–æ–≥–Ω–æ–∑ —Ä–∞–Ω–µ–µ, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—á–∏—Ç—ã–≤–∞–π –µ–≥–æ: "
        "–Ω–µ –º–µ–Ω—è–π —É—Ä–æ–≤–µ–Ω—å –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∑–∫–æ –±–µ–∑ —è–≤–Ω—ã—Ö –æ—Å–Ω–æ–≤–∞–Ω–∏–π. "
        "–ï—Å–ª–∏ –ø–æ—è–≤–∏–ª–∏—Å—å —Å–æ–º–Ω–µ–Ω–∏—è, —Å–Ω–∞—á–∞–ª–∞ –ø–ª–∞–≤–Ω–æ —Å–Ω–∏–∂–∞–π –∏–ª–∏ –ø–æ–≤—ã—à–∞–π —É—Ä–æ–≤–µ–Ω—å –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏, –∞ –Ω–µ –¥–µ–ª–∞–π —Ä–µ–∑–∫–∏—Ö —Å–∫–∞—á–∫–æ–≤. "
        "–í–ê–ñ–ù–û: –í –æ—Ç–≤–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (SenderId) –∏–∑ —á–∞—Ç–∞. "
        "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞ 'SenderId' –∏–ª–∏ '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', —Ç–æ–ª—å–∫–æ —Å–∞–º–∏ —á–∏—Å–ª–æ–≤—ã–µ ID. "
        "–û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, –≥–¥–µ –∫–ª—é—á–∏ ‚Äî —ç—Ç–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∞ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî —É—Ä–æ–≤–µ–Ω—å –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏."
        "–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞: {\"123\": 82.5, \"456\": 67.2}"
        "–ü—Ä–∏–º–µ—Ä –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞: {\"SenderId_123\": 82.5, \"user\": 67.2}"
    )
    history_context = f"–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Å–∞–º–º–µ—Ä–∏:\n{historical_summary}\n\n" if historical_summary else ""
    prev_context = ""
    if previous_engagement:
        prev_context = "–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏:\n"
        for uid, val in previous_engagement.items():
            prev_context += f"- {uid}: {val}\n"
        prev_context += "\n"
    user_content = f"{history_context}{prev_context}–ß–∞—Ç:\n{chat_text}"
    return [
        {"role": "system", "text": system_prompt},
        {"role": "user", "text": user_content}
    ]

def attachment_messages(chat_text: str, user_ids: list, historical_summary: str = "", previous_attachments: dict = None) -> list:
    system_prompt = (
        "You are the most professional and accurate dialogue analyst. "
        "Based on the chat history and new messages, determine the attachment type for each participant: 'secure', 'anxious', or 'avoidant', and the confidence (0 to 100). "
        "\n\nIMPORTANT RULES:"
        "\n1. If the current type matches the previous prediction AND new messages show clear signs of this type, increase confidence by 5-10 points."
        "\n2. If the current type differs from the previous prediction, decrease confidence by 10-15 points."
        "\n3. Only change the attachment type if confidence drops below 40%."
        "\n4. Confidence should never increase by more than 10 points at once."
        "\n5. If there are no clear signs of any type, decrease confidence by 5 points."
        "\n\nSIGNS OF EACH TYPE:"
        "\n- SECURE:"
        "\n  * Comfortable with both intimacy and independence"
        "\n  * Clear and direct communication"
        "\n  * Balanced emotional responses"
        "\n  * Example: 'I enjoy our time together, but I also need some space for my hobbies'"
        "\n- ANXIOUS:"
        "\n  * Seeks constant reassurance"
        "\n  * Worries about relationship stability"
        "\n  * Overanalyzes messages and responses"
        "\n  * Example: 'Are you sure you're not upset with me? You haven't replied in 5 minutes'"
        "\n- AVOIDANT:"
        "\n  * Maintains emotional distance"
        "\n  * Avoids deep conversations"
        "\n  * Prefers independence over closeness"
        "\n  * Example: 'I don't like to discuss feelings. Let's keep things casual'"
        "\n\nVERY IMPORTANT: Return a JSON object where keys are ONLY numeric user IDs from SenderId."
        "\nDO NOT use 'SenderId' or 'user' in the keys, use only the numbers. Each value should be an object with keys 'type' and 'confidence'."
        "\nCorrect example: {\"123\": {\"type\": \"secure\", \"confidence\": 75}, \"456\": {\"type\": \"anxious\", \"confidence\": 60}}"
        "\nIncorrect example: {\"SenderId_123\": {\"type\": \"secure\", \"confidence\": 75}, \"user\": {\"type\": \"anxious\", \"confidence\": 60}}"
        "\nUse only English for all keys and values."
    )
    history_context = f"History summary:\n{historical_summary}\n\n" if historical_summary else ""
    prev_context = ""
    if previous_attachments:
        prev_context = "Previous attachment predictions:\n"
        for uid, val in previous_attachments.items():
            prev_context += f"- {uid}: type={val.get('type', 'unknown')}, confidence={val.get('confidence', 0)}\n"
        prev_context += "\n"
    user_content = f"{history_context}{prev_context}Chat:\n{chat_text}"
    return [
        {"role": "system", "text": system_prompt},
        {"role": "user", "text": user_content}
    ]

def recommendations_messages(chat_text: str, historical_summary: str, user_id: str) -> List[Dict[str, str]]:
    """–°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π"""
    system_prompt = (
        "–¢—ã ‚Äî –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ—É—á."
        f"–¢–≤–æ—è –∑–∞–¥–∞—á–∞ –¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id} –æ–¥–Ω—É –∫–æ—Ä–æ—Ç–∫—É—é, –ø—Ä–∞–∫—Ç–∏—á–Ω—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é, –∫–∞–∫ —É–ª—É—á—à–∏—Ç—å –∏–ª–∏ —É–≥–ª—É–±–∏—Ç—å –æ–±—â–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ:"
        "–û–±–æ–±—â–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞,"
        "–ê–Ω–∞–ª–∏–∑–∞ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤,"
        "–®–∞–±–ª–æ–Ω–æ–≤ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏,"
        "–ù–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"
        "–§–æ—Ä–º—É–ª–∏—Ä—É–π –æ–¥–∏–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π —Å–æ–≤–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ª–µ–≥–∫–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å:"
        "—ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å, –ø—Ä–æ—è–≤–∏—Ç—å —ç–º–æ—Ü–∏—é, –ø—Ä–æ—è–≤–∏—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É) –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–µ–Ω–∏—é —Å–≤–æ–µ–π —Ä–æ–ª–∏ –≤ –æ–±—â–µ–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±—ã—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ –∫ —Ç–æ–Ω—É, —Å–Ω–∏–∑–∏—Ç—å –¥–∞–≤–ª–µ–Ω–∏–µ –∏ —Ç.–¥.)."
        "–ù–µ –¥–æ–±–∞–≤–ª—è–π –ø–æ—è—Å–Ω–µ–Ω–∏–π, –Ω–µ –¥–∞–≤–∞–π –¥–ª–∏–Ω–Ω—ã—Ö —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π ‚Äî —Ç–æ–ª—å–∫–æ —Å–æ–≤–µ—Ç."
        "–°–æ–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —É–∫–∞–∑–∞—Ç–µ–ª—å–Ω–æ–π —Ñ–æ—Ä–º–µ."
        "–°–æ–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –Ω–µ —Ç–æ–ª—å–∫–æ –∫ –ø–æ—Å–ª–µ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è–º, –Ω–æ –∏ –∫ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞, —É—á–∏—Ç—ã–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç."
        "–ü—Ä–∏–º–µ—Ä—ã —Å–æ–≤–µ—Ç–∞:"
        "–ü–æ–ø—Ä–æ–±—É–π –≤ –æ—Ç–≤–µ—Ç –∑–∞–¥–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å ‚Äî —ç—Ç–æ –ø–æ–∫–∞–∂–µ—Ç —Ç–≤–æ—é –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å"
        "–ü—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è –∏–ª–∏ —Ñ–∏–ª—å–º ‚Äî —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∏–¥–µ—é –≤ –¥–µ–π—Å—Ç–≤–∏–µ."
        "–î–æ–±–∞–≤—å –Ω–µ–º–Ω–æ–≥–æ –ª–∏—á–Ω–æ–≥–æ ‚Äî –Ω–µ–±–æ–ª—å—à–∞—è –¥–µ—Ç–∞–ª—å –æ —Å–µ–±–µ —Å–¥–µ–ª–∞–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä —Ç–µ–ø–ª–µ–µ."
    )
    
    history_context = f"–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Å–∞–º–º–µ—Ä–∏:\n{historical_summary}\n\n" if historical_summary else ""
    user_content = f"{history_context}. –î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}, –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:\n{chat_text}"
    
    return create_yandex_messages(system_prompt, user_content)

def summary_messages(chat_text: str, historical_summary: str = "") -> List[Dict[str, str]]:
    """–°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∞–º–º–µ—Ä–∏"""
    system_prompt = '''–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–∏–∞–ª–æ–≥–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Ç–æ—á–Ω–æ –∏ –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ —Ä–µ–∑—é–º–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π.

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¢–û–õ–¨–ö–û –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –¥–∏–∞–ª–æ–≥–∏ –∏–ª–∏ –¥–µ—Ç–∞–ª–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç.
2. –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –æ—Ç –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞, –æ—Ç–º–µ—Ç—å —ç—Ç–æ —è–≤–Ω–æ.
3. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –º–∞–ª–æ, —Å–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Ç–æ–ª—å–∫–æ –ø–æ —Ñ–∞–∫—Ç–∞–º.
4. –ù–ï –í–ö–õ–Æ–ß–ê–ô —Å—Å—ã–ª–∫–∏, –ø–æ–∏—Å–∫–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏–ª–∏ —Ñ—Ä–∞–∑—ã –æ —Ç–æ–º, —á—Ç–æ "–≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è".
5. –ù–ï –°–°–´–õ–ê–ô–°–Ø –Ω–∞ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
6. –ë—É–¥—å –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–º –∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–º.

–ï—Å–ª–∏ —Ç—ã –≤–∏–¥–∏—à—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ —Ä–µ–∑—é–º–∏—Ä—É–π –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ. 
–ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –æ—Ç–≤–µ—Ç—ã –∏–ª–∏ —Ä–µ–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö.

–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –¢–û–õ–¨–ö–û –Ω–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π.'''
    
    history_context = f"–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Å–∞–º–º–µ—Ä–∏:\n{historical_summary}\n\n" if historical_summary else ""
    user_content = f"{history_context}–û–±–Ω–æ–≤–∏ —Å–∞–º–º–µ—Ä–∏, —É—á–∏—Ç—ã–≤–∞—è —Å–ª–µ–¥—É—é—â–∏–π –Ω–æ–≤—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç —á–∞—Ç–∞:\n{chat_text}"
    
    return create_yandex_messages(system_prompt, user_content)

def legacy_analysis_messages(chat_text: str) -> List[Dict[str, str]]:
    """–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –±–∞—Ç—á–∞ (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)"""
    system_prompt = "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —á–∞—Ç –∏ –æ—Ü–µ–Ω–∏: —Å–∫–æ–ª—å–∫–æ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–æ–≤ —Å–¥–µ–ª–∞–ª –∫–∞–∂–¥—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∏ –∫–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏ —É –∫–∞–∂–¥–æ–≥–æ (–æ—Ç 0 –¥–æ 100). –û—Ç–≤–µ—Ç –¥–∞–π —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON."
    user_content = f"–ß–∞—Ç:\n{chat_text}\n\n–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞: {{\"A\": {{\"compliments\": 3, \"engagement_score\": 82.5}}, \"B\": {{\"compliments\": 1, \"engagement_score\": 67.0}}}}"
    
    return create_yandex_messages(system_prompt, user_content)

def update_summary(messages: List[Dict[str, Any]], historical_summary: Optional[str] = None) -> str:
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Å–∞–º–º–µ—Ä–∏ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    
    Args:
        messages: –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        historical_summary: –ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–∞–º–º–µ—Ä–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        
    Returns:
        –û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–∞–º–º–µ—Ä–∏
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    if not messages:
        return historical_summary or "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
    formatted_messages = []
    for msg in messages:
        sender = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" if msg.get("IsUser", False) else "–°–æ–±–µ—Å–µ–¥–Ω–∏–∫"
        formatted_messages.append(f"{sender}: {msg['Text']}")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
    prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Å–∞–º–º–µ—Ä–∏ –¥–∏–∞–ª–æ–≥–∞.

–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Å–∞–º–º–µ—Ä–∏:
{historical_summary if historical_summary else "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Å–∞–º–º–µ—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"}

–ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
{chr(10).join(formatted_messages)}

–í–∞–∂–Ω–æ:
1. –ï—Å–ª–∏ –≤ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞, —É–∫–∞–∂–∏ —ç—Ç–æ –≤ —Å–∞–º–º–µ—Ä–∏
2. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∏–∞–ª–æ–≥, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
3. –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ —Å–∞–º–º–µ—Ä–∏, –µ—Å–ª–∏ –æ–Ω —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω
4. –ò—Å–ø–æ–ª—å–∑—É–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ç–æ–Ω
5. –û–ø–∏—à–∏ —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã, –Ω–µ –¥–æ–±–∞–≤–ª—è–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–π
6. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –º–∞–ª–æ, —Å–¥–µ–ª–∞–π —Å–∞–º–º–µ—Ä–∏ –∫–æ—Ä–æ—Ç–∫–∏–º
7. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Å–≤—è–∑–∞–Ω—ã —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º, –Ω–∞—á–Ω–∏ –Ω–æ–≤–æ–µ —Å–∞–º–º–µ—Ä–∏
8. –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û: –≤–∫–ª—é—á–∞—Ç—å —Å—Å—ã–ª–∫–∏, —É–ø–æ–º–∏–Ω–∞—Ç—å –ø–æ–∏—Å–∫, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç, –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

–û–±–Ω–æ–≤–∏ —Å–∞–º–º–µ—Ä–∏, —Å–æ—Ö—Ä–∞–Ω—è—è –≤–∞–∂–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –¥–æ–±–∞–≤–ª—è—è –Ω–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é."""

    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º llm –≤–º–µ—Å—Ç–æ get_llm_response –Ω–∞–ø—Ä—è–º—É—é
        from processor.llm_handler import llm
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç LLM
        response = llm.get_llm_response(prompt)
        
        if response:
            print(f"üß† –ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤ –æ—Ç–≤–µ—Ç–∞: {response[:200]}...")
            
            # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç Markdown
            cleaned_response = llm._clean_markdown(response)
            print(f"üßπ –¢–µ–∫—Å—Ç –æ—á–∏—â–µ–Ω –æ—Ç Markdown: –±—ã–ª–æ {len(response)} —Å–∏–º–≤–æ–ª–æ–≤, —Å—Ç–∞–ª–æ {len(cleaned_response)}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            if hasattr(llm, '_contains_prohibited_content') and llm._contains_prohibited_content(cleaned_response):
                print("‚ö†Ô∏è –í —Å–∞–º–º–µ—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–∞–º–º–µ—Ä–∏")
                return historical_summary or "–°–∞–º–º–µ—Ä–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–æ"
                
            return cleaned_response
        else:
            print("‚ùå –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∞–º–º–µ—Ä–∏")
            return historical_summary or "–°–∞–º–º–µ—Ä–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–æ"
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∞–º–º–µ—Ä–∏: {e}")
        import traceback
        print(f"–°—Ç–µ–∫ –æ—à–∏–±–∫–∏ —Å–∞–º–º–µ—Ä–∏:\n{traceback.format_exc()}")
        return historical_summary or "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∞–º–º–µ—Ä–∏" 